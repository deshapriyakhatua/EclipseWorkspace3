<!DOCTYPE html>
<html>

<head>
	<meta charset="ISO-8859-1">
	<title>Insert title here</title>
</head>

<body>
	<header>
		<input id="username" placeholder="Username..." autofocus>
		<button id="connect">Connect</button>
		<button id="disconnect" disabled>Disconnect</button>
	</header>
	<aside>
		<h5>Online User(s)</h5>
		<ul id="userList">
		</ul>
	</aside>
	<article>
		<div id="dialog">
			<span>Chat to <input id="chatTo" type="text" value="all"></input>
			<div id="message-board"></div>
			<hr>
			<textarea id="message" placeholder="message.."></textarea>
			<button id="send">Send</button>
		</div>
	</article>
</body>

<script>

	//DOM Element
	var usernameInputEl = document.querySelector("#username");
	var connectBtnEl = document.querySelector('#connect');
	var disconnectBtnEl = document.querySelector('#disconnect');
	var usernameListEl = document.querySelector("#userList");
	var articleEl = document.querySelector('article');
	var messageBoardEl = articleEl.querySelector('#message-board');
	var messageInputEl = articleEl.querySelector('#message');
	var sendBtnEl = articleEl.querySelector('#send');
	//label in the message board title
	var chatToInput = articleEl.querySelector('#chatTo');


	//Chat room that holds every conversation
	var chatRoom = {
		'all': []
	};
	
	const SEPARATOR = "";

	//socket object.
	var socket = undefined;

	connectBtnEl.onclick = connect;
	disconnectBtnEl.onclick = disconnect;

	function connect() {
		
		socket = new WebSocket("ws://" + "localhost:8080/findNearest/" + "chat?username=" + usernameInputEl.value);

		socket.onopen = socketOnOpen;
		socket.onmessage = socketOnMessage;
		socket.onclose = socketOnClose;
	}

	function disconnect() {
		socket.close();
		socket = undefined;
	}

	function socketOnOpen(e) {
		usernameInputEl.disabled = true;
		connectBtnEl.disabled = true;
		disconnectBtnEl.disabled = false;
	}

	function socketOnMessage(e) {
		
		let eventName = e.data.substr(0, e.data.indexOf("|"));
		let data = e.data.substr(e.data.indexOf("|") + 1);
		let dataArr = data.split('|');
		
		if (eventName == 'newUser')  newUser(...dataArr);
		else if (eventName == 'message') getMessage(...dataArr);
		else if (eventName == 'removeUser') removeUser(...dataArr);
		
	}

	function socketOnClose(e) {
		usernameInputEl.disabled = false;
		connectBtnEl.disabled = false;
		disconnectBtnEl.disabled = true;
		usernameInputEl.value = '';
		messageBoardEl.innerHTML = '';
		usernameListEl.innerHTML = '';
	}

	function newUser() {
		//if there is no users, return from the function
		if (arguments.length == 1 && arguments[0] == "") return;
		var usernameList = arguments;

		//Loop through all online users and create a list from it
		var documentFragment = document.createDocumentFragment();
		for (var i = 0; i < usernameList.length; i++) {
			var username = usernameList[i];
			var liEl = document.createElement("li");
			liEl.id = username;
			liEl.textContent = username;
			if (username != usernameInputEl.value) liEl.classList.add('hoverable');
			documentFragment.appendChild(liEl);
		};
		usernameListEl.appendChild(documentFragment);
	}

	function getMessage(sender, message, recipient) {
		console.log(sender, message, recipient);

		let newChatEl = createNewChat(sender, message);
		messageBoardEl.appendChild(newChatEl);
		console.log(messageBoardEl);
		
		if (chatRoom[recipient]) chatRoom[recipient].push(message);
		else chatRoom[recipient] = [message];
		console.log(chatRoom);
	}

	function removeUser(removedUsername) {
		var usernameList = usernameListEl.children;
		for (var i = 0; i < usernameList.length; i++) {
			var username = usernameList[i].textContent;
			if (username == removedUsername) {
				usernameListEl.removeChild(usernameList[i]);
			}
		}
	}
	
	//--

	function createNewChat(sender, message) {
		var newChatDivEl = document.createElement('div');
		var senderEl = document.createElement('span');
		var messageEl = document.createElement('span');

		if (sender == usernameInputEl.value)
			sender = 'me';

		senderEl.textContent = sender + ": ";
		messageEl.textContent = message;

		newChatDivEl.appendChild(senderEl);
		newChatDivEl.appendChild(messageEl);
		return newChatDivEl;
	}
	
	// send message

	sendBtnEl.onclick = sendMessage;

	function sendMessage() {
		let message = messageInputEl.value;
		if (message == '') return;
		let sender = usernameInputEl.value;
		let recipient = chatToInput.value;
		socket.send(sender + '|' + message + '|' + recipient);
		messageInputEl.value = '';
		
		let newChatEl = createNewChat(sender, message);
		messageBoardEl.appendChild(newChatEl);
		messageBoardEl.scrollTop = messageBoardEl.scrollHeight;
	}

	
</script>

</html>